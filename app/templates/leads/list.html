{% extends "base.html" %}

{% block title %}Lead List{% end block %}

{% block content_header %}
<div class="container-fluid">
    <div class="row mb-2">
        <div class="col-sm-6">
            <h1 class="m-0">Lead Management</h1>
        </div>
        <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
                <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Home</a></li>
                <li class="breadcrumb-item active">Leads</li>
            </ol>
        </div>
    </div>
</div>
{% end block %}

{% block content %}
<div class="container-fluid">
    {# Lead Summary/Key Performance Indicators (KPIs) #}
    <div class="row">
        <div class="col-lg-3 col-6">
            {# Small Box for Total Leads #}
            <div class="small-box bg-info">
                <div class="inner">
                    <h3>{{ total_leads | default(0) }}</h3>
                    <p>Total Leads</p>
                </div>
                <div class="icon">
                    <i class="fas fa-users"></i>
                </div>
                <a href="{{ url_for('leads.list_leads') }}" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
            </div>
        </div>
        <div class="col-lg-3 col-6">
            {# Small Box for New Leads #}
            <div class="small-box bg-warning">
                <div class="inner">
                    <h3>{{ new_leads_count | default(0) }}</h3>
                    <p>New Leads</p>
                </div>
                <div class="icon">
                    <i class="fas fa-user-plus"></i>
                </div>
                <a href="{{ url_for('leads.list_leads', status='New') }}" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
            </div>
        </div>
        <div class="col-lg-3 col-6">
            {# Small Box for Qualified Leads #}
            <div class="small-box bg-success">
                <div class="inner">
                    <h3>{{ qualified_leads_count | default(0) }}</h3>
                    <p>Qualified Leads</p>
                </div>
                <div class="icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <a href="{{ url_for('leads.list_leads', status='Qualified') }}" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
            </div>
        </div>
        <div class="col-lg-3 col-6">
            {# Small Box for Converted Leads #}
            <div class="small-box bg-primary">
                <div class="inner">
                    <h3>{{ converted_leads_count | default(0) }}</h3>
                    <p>Converted Leads</p>
                </div>
                <div class="icon">
                    <i class="fas fa-trophy"></i>
                </div>
                <a href="{{ url_for('leads.list_leads', status='Converted') }}" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
            </div>
        </div>
    </div>

    {# Filter and Sort Leads Card #}
    <div class="card card-primary card-outline">
        <div class="card-header">
            <h3 class="card-title">Filter and Sort Leads</h3>
            <div class="card-tools">
                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                    <i class="fas fa-minus"></i>
                </button>
            </div>
        </div>
        <div class="card-body">
            <form method="GET" action="{{ url_for('leads.list_leads') }}" id="leadFilterForm">
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="search">Search</label>
                            <input type="text" class="form-control" id="search" name="search" placeholder="Search by name, company, email..." value="{{ query_params.get('search', '') }}">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="status">Status</label>
                            <select class="form-control" id="status" name="status">
                                <option value="">All Statuses</option>
                                {% for status in lead_statuses %}
                                <option value="{{ status }}" {% if query_params.get('status') == status %}selected{% endif %}>{{ status }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="source">Source</label>
                            <select class="form-control" id="source" name="source">
                                <option value="">All Sources</option>
                                {% for source in lead_sources %}
                                <option value="{{ source }}" {% if query_params.get('source') == source %}selected{% endif %}>{{ source }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="sales_rep">Sales Representative</label>
                            <select class="form-control" id="sales_rep" name="sales_rep">
                                <option value="">All Sales Reps</option>
                                {% for rep in sales_representatives %}
                                <option value="{{ rep.id }}" {% if query_params.get('sales_rep') == rep.id|string %}selected{% endif %}>{{ rep.full_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="start_date">Created After</label>
                            <input type="date" class="form-control" id="start_date" name="start_date" value="{{ query_params.get('start_date', '') }}">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="end_date">Created Before</label>
                            <input type="date" class="form-control" id="end_date" name="end_date" value="{{ query_params.get('end_date', '') }}">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="sort_by">Sort By</label>
                            <select class="form-control" id="sort_by" name="sort_by">
                                <option value="created_at" {% if query_params.get('sort_by', 'created_at') == 'created_at' %}selected{% endif %}>Creation Date</option>
                                <option value="last_contact_date" {% if query_params.get('sort_by') == 'last_contact_date' %}selected{% endif %}>Last Contact</option>
                                <option value="name" {% if query_params.get('sort_by') == 'name' %}selected{% endif %}>Lead Name</option>
                                <option value="company_name" {% if query_params.get('sort_by') == 'company_name' %}selected{% endif %}>Company Name</option>
                                <option value="status" {% if query_params.get('sort_by') == 'status' %}selected{% endif %}>Status</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="sort_order">Sort Order</label>
                            <select class="form-control" id="sort_order" name="sort_order">
                                <option value="desc" {% if query_params.get('sort_order', 'desc') == 'desc' %}selected{% endif %}>Descending</option>
                                <option value="asc" {% if query_params.get('sort_order') == 'asc' %}selected{% endif %}>Ascending</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 text-right">
                        <button type="submit" class="btn btn-primary mr-2"><i class="fas fa-filter"></i> Apply Filters</button>
                        <a href="{{ url_for('leads.list_leads') }}" class="btn btn-secondary"><i class="fas fa-sync-alt"></i> Clear Filters</a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    {# Leads Table Card #}
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">All Leads</h3>
            <div class="card-tools">
                <a href="{{ url_for('leads.create_lead') }}" class="btn btn-success btn-sm">
                    <i class="fas fa-plus"></i> Add New Lead
                </a>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-striped">
                    <thead>
                        <tr>
                            <th>Lead Name</th>
                            <th>Company</th>
                            <th>Status</th>
                            <th>Source</th>
                            <th>Sales Rep</th>
                            <th>Last Contact</th>
                            <th>Created On</th>
                            <th style="width: 150px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if pagination.items %}
                            {% for lead in pagination.items %}
                            <tr>
                                <td><a href="{{ url_for('leads.view_lead', lead_id=lead.id) }}">{{ lead.name }}</a></td>
                                <td>{{ lead.company_name | default('N/A') }}</td>
                                <td><span class="badge badge-{{ lead.status | status_badge_color }}">{{ lead.status }}</span></td>
                                <td>{{ lead.source | default('N/A') }}</td>
                                <td>{{ lead.sales_representative.full_name if lead.sales_representative else 'Unassigned' }}</td>
                                <td>{{ lead.last_contact_date.strftime('%Y-%m-%d') if lead.last_contact_date else 'N/A' }}</td>
                                <td>{{ lead.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    <a href="{{ url_for('leads.view_lead', lead_id=lead.id) }}" class="btn btn-info btn-sm" data-toggle="tooltip" title="View Lead"><i class="fas fa-eye"></i></a>
                                    <a href="{{ url_for('leads.edit_lead', lead_id=lead.id) }}" class="btn btn-primary btn-sm" data-toggle="tooltip" title="Edit Lead"><i class="fas fa-edit"></i></a>
                                    <button type="button" class="btn btn-danger btn-sm delete-lead-btn" data-id="{{ lead.id }}" data-name="{{ lead.name }}" data-toggle="tooltip" title="Delete Lead"><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="8" class="text-center">No leads found matching your criteria.</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer clearfix">
            {# Pagination controls #}
            <ul class="pagination pagination-sm m-0 float-right">
                {% if pagination.has_prev %}
                <li class="page-item"><a class="page-link" href="{{ url_for('leads.list_leads', page=pagination.prev_num, **query_params) }}">«</a></li>
                {% else %}
                <li class="page-item disabled"><a class="page-link" href="#">«</a></li>
                {% endif %}

                {% for p in pagination.iter_pages() %}
                    {% if p %}
                        {% if p == pagination.page %}
                        <li class="page-item active"><a class="page-link" href="#">{{ p }}</a></li>
                        {% else %}
                        <li class="page-item"><a class="page-link" href="{{ url_for('leads.list_leads', page=p, **query